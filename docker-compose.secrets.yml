# Docker Compose override file for production using Docker Secrets
#
# This file demonstrates how to use Docker secrets instead of environment
# variables for sensitive credentials in production environments.
#
# Usage:
#   1. Create secrets:
#      echo "your-api-key" | docker secret create anthropic_api_key -
#      echo "your-ntfy-topic" | docker secret create ntfy_topic -
#
#   2. Deploy with both compose files:
#      docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
# Note: Docker secrets require Swarm mode or Docker Compose v2.0+
#       For standalone Docker, secrets are stored in /run/secrets/

version: '3.8'

secrets:
  anthropic_api_key:
    external: true
  google_api_key:
    external: true
  ntfy_topic:
    external: true

services:
  briefly:
    secrets:
      - anthropic_api_key
      - google_api_key
      - ntfy_topic
    environment:
      # Override environment variables to read from secrets
      # These use the /run/secrets/ files created by Docker
      - ANTHROPIC_API_KEY_FILE=/run/secrets/anthropic_api_key
      - GOOGLE_API_KEY_FILE=/run/secrets/google_api_key
      - BRIEFLY_NTFY_TOPIC_FILE=/run/secrets/ntfy_topic

    # Note: If your application doesn't support _FILE suffix for reading secrets,
    # you'll need to modify the application code to read from /run/secrets/ directly
    # or use an entrypoint script to export the secrets as environment variables:
    #
    # entrypoint: /bin/sh -c '
    #   export ANTHROPIC_API_KEY=$$(cat /run/secrets/anthropic_api_key 2>/dev/null || echo "");
    #   export GOOGLE_API_KEY=$$(cat /run/secrets/google_api_key 2>/dev/null || echo "");
    #   export BRIEFLY_NTFY_TOPIC=$$(cat /run/secrets/ntfy_topic 2>/dev/null || echo "");
    #   exec /app/briefly'
