version: '3.8'

# PODMAN SETUP REQUIRED:
# Before running with Podman, enable the Podman socket for Watchtower:
#   Rootful (as root):    sudo systemctl enable --now podman.socket
#   Rootless (as user):   systemctl --user enable --now podman.socket
#
# Without the socket, Watchtower won't be able to update containers.
# You can still run Briefly without Watchtower by commenting out the watchtower service.

# ENVIRONMENT VARIABLE PRECEDENCE:
# Docker Compose reads variables in this order (first match wins):
#   1. Shell environment variables (export ANTHROPIC_API_KEY=...)
#   2. .env file in the same directory
#   3. Default values specified with ${VAR:-default}
#
# SECURE USAGE (no .env file needed):
#   export ANTHROPIC_API_KEY="your-key"
#   export BRIEFLY_NTFY_TOPIC="your-topic"
#   docker compose up -d
#
# OR use a single command:
#   ANTHROPIC_API_KEY="your-key" docker compose up -d
#
# OR integrate with a vault (HashiCorp Vault, 1Password, etc):
#   export ANTHROPIC_API_KEY=$(vault kv get -field=api_key secret/briefly)
#   docker compose up -d

services:
  # Main Briefly service
  briefly:
    image: briefly:latest
    container_name: briefly
    restart: unless-stopped

    # For Podman: preserve host user permissions
    # userns_mode: keep-id  # Uncomment for rootless Podman

    environment:
      # LLM Provider Configuration
      - BRIEFLY_LLM_PROVIDER=${BRIEFLY_LLM_PROVIDER:-claude}
      - BRIEFLY_LLM_MODEL=${BRIEFLY_LLM_MODEL:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}

      # Directory Configuration
      - BRIEFLY_WATCH_DIR=/data/inbox
      - BRIEFLY_OUTPUT_DIR=/data/output

      # Whisper Configuration
      - BRIEFLY_WHISPER_MODEL=${BRIEFLY_WHISPER_MODEL:-base}

      # Notification Configuration
      - BRIEFLY_NTFY_TOPIC=${BRIEFLY_NTFY_TOPIC:-}
    volumes:
      # Mount host directories for input and output
      # :Z suffix sets SELinux context for exclusive container access
      - ${BRIEFLY_HOST_INBOX:-./inbox}:/data/inbox:Z
      - ${BRIEFLY_HOST_OUTPUT:-./output}:/data/output:Z
    labels:
      # Enable Watchtower monitoring for this container
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - briefly-network

  # Watchtower - Automatic container updates
  # DISABLED: Uncomment to enable automatic updates when Podman socket is available
  # watchtower:
  #   image: containrrr/watchtower:latest
  #   container_name: watchtower
  #   restart: unless-stopped
  #   environment:
  #     # Update check interval (default: 24 hours)
  #     # Format: seconds (e.g., 3600 = 1 hour, 86400 = 24 hours)
  #     - WATCHTOWER_POLL_INTERVAL=${WATCHTOWER_POLL_INTERVAL:-86400}
  #
  #     # Cleanup old images after update
  #     - WATCHTOWER_CLEANUP=true
  #
  #     # Include stopped containers in updates
  #     - WATCHTOWER_INCLUDE_STOPPED=true
  #
  #     # Include restarting containers
  #     - WATCHTOWER_INCLUDE_RESTARTING=true
  #
  #     # Only monitor containers with the watchtower label
  #     - WATCHTOWER_LABEL_ENABLE=true
  #
  #     # Notification settings (optional)
  #     # Uncomment and configure if you want Watchtower notifications
  #     # - WATCHTOWER_NOTIFICATIONS=shoutrrr
  #     # - WATCHTOWER_NOTIFICATION_URL=smtp://username:password@host:port/?from=fromAddress&to=toAddress
  #
  #     # Debug mode (set to true for verbose logging)
  #     - WATCHTOWER_DEBUG=${WATCHTOWER_DEBUG:-false}
  #
  #     # Rolling restart (update one container at a time)
  #     - WATCHTOWER_ROLLING_RESTART=false
  #   volumes:
  #     # Mount container runtime socket to allow Watchtower to manage containers
  #
  #     # For Docker (default):
  #     # - /var/run/docker.sock:/var/run/docker.sock
  #
  #     # For Podman (rootful - running as root):
  #     - /run/podman/podman.sock:/var/run/docker.sock
  #
  #     # For Podman (rootless - running as regular user):
  #     # Replace 1000 with your UID (run: echo $UID)
  #     # - /run/user/1000/podman/podman.sock:/var/run/docker.sock
  #
  #     # NOTE: Podman socket must be enabled first:
  #     #   Rootful:   sudo systemctl enable --now podman.socket
  #     #   Rootless:  systemctl --user enable --now podman.socket
  #   networks:
  #     - briefly-network
  #   labels:
  #     # Prevent Watchtower from updating itself
  #     - "com.centurylinklabs.watchtower.enable=false"

networks:
  briefly-network:
    driver: bridge
